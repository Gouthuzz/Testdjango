pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        deleteDir()
        checkout scm
      }
    }

    stage('Create Virtual Environment') {
      steps {
        sh '''#!/bin/bash
          python3 -m venv myenv
        '''
      }
    }

    stage('Upgrade Pip') {
      steps {
        sh '''#!/bin/bash
          source myenv/bin/activate
          pip install --upgrade pip
        '''
      }
    }

    stage('Install Django') {
      steps {
        sh '''#!/bin/bash
          source myenv/bin/activate
          pip install Django==4.2.14
        '''
      }
    }

    stage('Run Migrations') {
      steps {
        sh '''#!/bin/bash
          source myenv/bin/activate
          python3 manage.py migrate
        '''
      }
    }

    stage('Run Tests') {
      steps {
        sh '''#!/bin/bash
          source myenv/bin/activate
          python3 manage.py test
        '''
      }
    }

    stage('Build Docker Image') {
      steps {
        sh 'docker build -t my-django-app:latest .'
      }
    }

    stage('Push Docker Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh '''#!/bin/bash
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker tag my-django-app:latest <kannang349@gmail.com>/my-django-app:latest
            docker push <kannang349@gmail.com>/my-django-app:latest
          '''
        }
      }
    }
  }

  post {
    always {
      echo 'Pipeline completed'
    }
  }
}
